<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

body {
    min-height: 100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background: #f0f4f8;
    color: #333;
    overflow: hidden;
    position: relative;
    transition: background 1s ease;
}

/* Ğ¡Ğ¼Ğ°Ğ¹Ğ»Ğ¸ĞºĞ¸ */
.smile { position: absolute; top: -30px; opacity: 0.7; animation: fall linear infinite; z-index: 1; pointer-events: none; }
@keyframes fall { 0% { top: -30px; transform: rotate(0deg); opacity: 0.8; } 100% { top: 110%; transform: rotate(360deg); opacity: 0; } }

/* ĞšÑ€ĞµÑÑ‚Ğ¸ĞºĞ¸ */
.cross { position: absolute; font-size: 20px; opacity: 0.9; color: red; animation: crossFly 0.8s ease-out forwards; z-index: 15; pointer-events: none; }
@keyframes crossFly { 0% { transform: translate(0,0) rotate(0deg); opacity:1; } 100% { transform: translate(calc(-50px + 100px*var(--rand-x)), -150px) rotate(360deg); opacity:0; } }

.container { position: relative; background: #fff9f7; padding: 30px 20px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); z-index: 10; transition: background 1s ease; }
h1 { font-size: 26px; margin-bottom: 20px; color: #555; }
p { font-size: 18px; margin-bottom: 18px; line-height: 1.6; color: #444; }

/* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ */
.progress-container { width: 100%; background: #eee; border-radius: 12px; overflow: hidden; height: 20px; margin-bottom: 12px; }
.progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff6f61, #ff9f80); transition: width 0.2s; box-shadow: inset 0 -3px 8px rgba(0,0,0,0.05); }
.time-text { font-size: 14px; color: #666; margin-bottom: 14px; }

.hint { margin-top: 18px; background: #e8f4ff; padding: 15px; border-radius: 12px; font-size: 16px; color: #333; display: none; }

form input { width: 100%; padding: 15px 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; outline: none; background: #fff; color: #555; transition: all 0.3s ease; }
form input:focus { border-color: #ff6f61; box-shadow: 0 0 15px rgba(255,111,97,0.2); }

form button { width: 100%; padding: 12px; border: none; border-radius: 12px; background: #ffd1dc; font-size: 16px; color: #555; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
form button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }

#hintBtn { margin-top: 10px; background: #cce5ff; color: #004085; }

.admin-link { position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: rgba(85,85,85,0.3); text-decoration: none; }
.admin-link:hover { color: rgba(85,85,85,0.7); }

@media (max-width:480px){ h1{ font-size:22px; } p{ font-size:16px; } form input, form button{ padding:12px; font-size:16px; } }
</style>
</head>
<body>

<div class="container" role="main" aria-live="polite">
    <h1>Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ</h1>
    <p>{{ level.text }}</p>

    <div class="progress-container" aria-hidden="true">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="time-text">Ğ’Ñ€ĞµĞ¼Ñ: <span id="timer">0</span> ÑĞµĞº â€” Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· <span id="remaining">{{ hint_delay|default(30) }}</span> ÑĞµĞº</div>

    <form method="post" id="levelForm" autocomplete="off">
        <input type="text" name="next_code" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´" required>
        <button type="submit">ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ</button>
    </form>

    <form method="post" id="hintForm" style="display:none;">
        <button type="submit" name="use_hint" id="hintBtn">ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºÑƒ</button>
    </form>

    <div class="hint" id="hintBox">{{ level.hint or "ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ¿Ğ¾ĞºĞ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°" }}</div>
</div>

<a href="{{ url_for('admin_login') }}" class="admin-link">Admin</a>

<!-- Ğ—Ğ²ÑƒĞºĞ¸ -->
<audio id="correctSound" src="{{ url_for('static', filename='sounds/correct.mp3') }}"></audio>
<audio id="wrongSound" src="{{ url_for('static', filename='sounds/wrong.mp3') }}"></audio>

<script>
let hintDelay = {{ hint_delay|default(30) }};
let elapsed = 0;
let progressEl = document.getElementById('progressBar');
let remainingEl = document.getElementById('remaining');
let hintForm = document.getElementById('hintForm');
let hintBox = document.getElementById('hintBox');
let hintShown = {{ hint_shown|default(false)|tojson }};

// === Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ„Ğ¾Ğ½ Ğ´Ğ»Ñ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ ===
let backgrounds = [
    'linear-gradient(to bottom, #ffe6f0, #fff0f5)',
    'linear-gradient(to bottom, #e6f0ff, #ffffff)',
    'linear-gradient(to bottom, #e6ffe6, #f0fff0)',
    'linear-gradient(to bottom, #fffbe6, #fff5e6)',
    'linear-gradient(to bottom, #f0e6ff, #f5f0ff)'
];
let currentLevel = {{ level.id }};
document.body.style.background = backgrounds[currentLevel % backgrounds.length];

// === ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¸ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° ===
function updateProgress(){
    elapsed++;
    let percent = Math.min(elapsed / hintDelay * 100, 100);
    progressEl.style.width = percent + "%";
    document.getElementById('timer').innerText = elapsed;
    remainingEl.innerText = Math.max(hintDelay - elapsed,0);
    if(elapsed >= hintDelay){
        hintForm.style.display = 'block';
        clearInterval(progressInterval);
    }
}

if(hintShown){
    hintBox.style.display = 'block';
    hintForm.style.display = 'none';
    progressEl.style.width = '100%';
    remainingEl.innerText = 0;
} else {
    var progressInterval = setInterval(updateProgress,1000);
}

// === Ğ¡Ğ¼Ğ°Ğ¹Ğ»Ğ¸ĞºĞ¸ ===
let emojiSets = [
    ['ğŸ’–','ğŸ’—','ğŸ’˜','ğŸ’','â¤ï¸'],
    ['ğŸŒˆ','âœ¨','ğŸŒŸ','ğŸ’«','ğŸŒ¸'],
    ['ğŸ€','ğŸŒ¼','ğŸŒ·','ğŸŒ¹','ğŸŒ»'],
    ['âš¡ï¸','ğŸ”¥','ğŸ’¥','ğŸŒª','ğŸŒŠ'],
    ['ğŸ§©','ğŸ”','ğŸ—','ğŸ“œ','ğŸ•¯']
];
let emojis = emojiSets[currentLevel % emojiSets.length] || emojiSets[0];
let numSmiles = 30 + Math.floor(Math.random()*20);
for(let i=0;i<numSmiles;i++){
    let span = document.createElement('span');
    span.className = 'smile';
    span.innerText = emojis[Math.floor(Math.random()*emojis.length)];
    span.style.left = (Math.random()*120-10)+'vw';
    span.style.fontSize = (12+Math.random()*18)+'px';
    span.style.animationDuration = (4+Math.random()*6)+'s';
    span.style.animationDelay = (Math.random()*3)+'s';
    document.body.appendChild(span);
}

// === ĞšÑ€ĞµÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ===
function showCrosses(num=10){
    for(let i=0;i<num;i++){
        let cross = document.createElement('span');
        cross.className = 'cross';
        cross.innerText = 'âœ–ï¸';
        cross.style.left = (50+(Math.random()-0.5)*60)+'vw';
        cross.style.top = (40+(Math.random()-0.5)*20)+'vh';
        cross.style.setProperty('--rand-x', Math.random());
        cross.style.fontSize = (14+Math.random()*26)+'px';
        document.body.appendChild(cross);
        setTimeout(()=>{ cross.remove(); },900);
    }
}

// === ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ° + Ğ·Ğ²ÑƒĞºĞ¸ ===
document.getElementById('levelForm').addEventListener('submit', function(e){
    let input = this.next_code.value.trim();
    let correct = {{ (level.next_code or '')|tojson }};
    if(correct === null) correct = "";
    if(input !== correct){
        e.preventDefault();
        showCrosses(12);
        this.next_code.value = '';
        document.getElementById('wrongSound').play();
    } else {
        document.getElementById('correctSound').play();
    }
});

// === ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ===
hintForm.addEventListener('submit', function(e){
    e.preventDefault();
    hintBox.style.display = 'block';
    hintForm.style.display = 'none';
    progressEl.style.width = '100%';
    remainingEl.innerText = 0;
});
</script>

</body>
</html>